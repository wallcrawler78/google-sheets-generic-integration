<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .header h2 {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .header p {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #f9f9f9;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: none;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }

    .tab-button:hover {
      background: #f1f3f4;
      color: #333;
    }

    .tab-button.active {
      color: #1a73e8;
      background: white;
      border-bottom-color: #1a73e8;
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* Racks Tab Styles */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .info-box {
      background: #e8f0fe;
      border-left: 3px solid #1a73e8;
      padding: 12px;
      margin: 12px 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #174ea6;
    }

    .search-box {
      margin: 0 15px 12px 15px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }

    .search-box input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .rack-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 15px 70px 15px; /* Extra padding for button */
    }

    .rack-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }

    .rack-item:hover {
      border-color: #1a73e8;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.15);
    }

    .rack-item.selected {
      background-color: #e8f0fe;
      border-color: #1a73e8;
    }

    .rack-number {
      font-weight: bold;
      color: #1a73e8;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .rack-name {
      font-size: 12px;
      color: #333;
      margin-bottom: 2px;
    }

    .rack-description {
      font-size: 11px;
      color: #80868b;
      margin-bottom: 4px;
    }

    .rack-stats {
      font-size: 11px;
      color: #80868b;
      margin-top: 4px;
      display: flex;
      gap: 12px;
    }

    .insert-button {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1a73e8 0%, #174ea6 100%);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .insert-button:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .insert-button:active {
      transform: translateY(0);
    }

    .insert-button:disabled {
      background: #dadce0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Quantities Tab Styles */
    .quantity-controls {
      padding: 12px 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #e0e0e0;
    }

    .quantity-scope {
      margin-bottom: 12px;
    }

    .quantity-scope-label {
      font-size: 11px;
      font-weight: bold;
      color: #333;
      margin-bottom: 6px;
      display: block;
    }

    .scope-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .scope-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .scope-btn:hover {
      border-color: #1a73e8;
      background: #f8f9fa;
    }

    .scope-btn.active {
      border-color: #1a73e8;
      background: #e8f0fe;
      color: #1a73e8;
      font-weight: bold;
    }

    .quantity-summary {
      padding: 12px 15px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-stat {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
    }

    .stat-label {
      color: #666;
    }

    .stat-value {
      font-weight: bold;
      color: #1a73e8;
    }

    .quantity-list-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 15px;
    }

    .quantity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    .qty-item-number {
      font-size: 13px;
      font-weight: 500;
      color: #1a73e8;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .qty-item-number:hover {
      text-decoration: underline;
      color: #174ea6;
    }

    .qty-item-name {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    .qty-color-indicator {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #ddd;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .qty-badge {
      background: #ea4335;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .hidden {
      display: none !important;
    }

    .help-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      background: #1a73e8;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
      vertical-align: middle;
    }

    .help-icon:hover {
      background: #174ea6;
      transform: scale(1.1);
    }

    .tab-header {
      display: flex;
      align-items: center;
      padding: 0 15px 10px 15px;
      font-size: 14px;
      color: #5f6368;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <h2>Rack Picker</h2>
      <p>Select rack configurations to place in overview</p>
    </div>

    <div class="tab-nav">
      <button class="tab-button active" onclick="switchTab('racks')">üóÑÔ∏è Racks</button>
      <button class="tab-button" onclick="switchTab('arena')">üåê From Arena</button>
      <button class="tab-button" onclick="switchTab('quantities')">üìä Quantities</button>
    </div>

    <!-- Racks Tab -->
    <div class="tab-content active" id="racksTab">
      <div class="content">
        <div class="tab-header">
          üóÑÔ∏è Existing Rack Configurations
          <span class="help-icon" onclick="showRacksHelp()" title="Click for help">?</span>
        </div>

        <div class="search-box">
          <input type="text"
                 id="searchBox"
                 placeholder="Search rack configurations..."
                 onkeyup="filterRacks()">
        </div>

        <div id="rackList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading rack configurations...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="insertButton" onclick="insertRack()" disabled>
        Place Rack in Selected Cell
      </button>
    </div>

    <!-- From Arena Tab -->
    <div class="tab-content" id="arenaTab">
      <div class="content">
        <div class="tab-header">
          üåê Browse All Arena Items
          <span class="help-icon" onclick="showArenaHelp()" title="Click for help">?</span>
        </div>

        <div class="search-box">
          <input type="text"
                 id="arenaSearchBox"
                 placeholder="Search Arena items..."
                 onkeyup="filterArenaItems()">
        </div>

        <div id="arenaItemList" class="rack-list">
          <div class="loading">
            <div class="spinner"></div>
            <div>Loading Arena items...</div>
          </div>
        </div>
      </div>

      <button class="insert-button" id="arenaInsertButton" onclick="insertArenaItem()" disabled>
        Place Item (Auto-Create Rack)
      </button>
    </div>

    <!-- Quantities Tab -->
    <div class="tab-content" id="quantitiesTab">
      <div class="quantity-controls">
        <div class="quantity-scope">
          <span class="quantity-scope-label">Count Racks From:</span>
          <div class="scope-buttons">
            <button class="scope-btn active" data-scope="current" onclick="changeScope('current')">
              Current Sheet
            </button>
            <button class="scope-btn" data-scope="overview" onclick="changeScope('overview')">
              Overview Only
            </button>
            <button class="scope-btn" data-scope="racks" onclick="changeScope('racks')">
              All Racks
            </button>
            <button class="scope-btn" data-scope="all" onclick="changeScope('all')">
              All Sheets
            </button>
          </div>
        </div>
      </div>

      <div class="quantity-summary">
        <div class="summary-stat">
          <span class="stat-label">Unique Racks:</span>
          <span class="stat-value" id="uniqueCount">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Total Placements:</span>
          <span class="stat-value" id="totalQuantity">0</span>
        </div>
        <div class="summary-stat">
          <span class="stat-label">Scope:</span>
          <span class="stat-value" id="scopeName">Current Sheet</span>
        </div>
      </div>

      <div id="quantitiesLoading" class="loading hidden">
        <div class="spinner"></div>
        <p>Calculating rack usage...</p>
      </div>

      <div class="quantity-list-container" id="quantityListContainer">
        <div class="empty-state">
          <p>No racks found</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    var allRacks = [];
    var selectedRack = null;
    var quantities = {};
    var currentScope = 'current';

    // Arena items tab variables
    var allArenaItems = [];
    var filteredArenaItems = [];
    var selectedArenaItem = null;
    var arenaItemsLoaded = false;

    // Store arena items with GUID for linking
    var arenaItemsLookup = {};

    // Load rack configurations when sidebar opens
    google.script.run
      .withSuccessHandler(displayRacks)
      .withFailureHandler(showError)
      .getAllRackConfigurationsForPicker();

    function switchTab(tabName) {
      // Update tab buttons
      var buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update tab content
      var tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });

      if (tabName === 'racks') {
        document.getElementById('racksTab').classList.add('active');
      } else if (tabName === 'arena') {
        document.getElementById('arenaTab').classList.add('active');
        loadArenaItems(); // Load Arena items when tab is opened
      } else if (tabName === 'quantities') {
        document.getElementById('quantitiesTab').classList.add('active');
        loadQuantities(); // Load quantities when tab is opened
      }
    }

    function displayRacks(racks) {
      allRacks = racks;

      if (racks.length === 0) {
        document.getElementById('rackList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <div><strong>No rack configurations found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Create rack configurations using:<br>
              Create Layout ‚Üí New Rack Configuration
            </div>
          </div>
        `;
        return;
      }

      renderRacks(racks);
    }

    function renderRacks(racks) {
      var html = '';

      racks.forEach(function(rack) {
        var childCount = rack.childItemCount || 0;
        var childText = childCount === 1 ? '1 item' : childCount + ' items';

        html += `
          <div class="rack-item" onclick="selectRack('${rack.itemNumber}')">
            <div class="rack-number">${rack.itemNumber}</div>
            <div class="rack-name">${rack.itemName || 'Unnamed Rack'}</div>
            ${rack.description ? '<div class="rack-description">' + rack.description + '</div>' : ''}
            <div class="rack-stats">
              <span>üì¶ ${childText}</span>
              <span>üìÑ ${rack.sheetName}</span>
            </div>
          </div>
        `;
      });

      document.getElementById('rackList').innerHTML = html;
    }

    function selectRack(itemNumber) {
      selectedRack = allRacks.find(function(r) { return r.itemNumber === itemNumber; });

      // Update UI
      var rackItems = document.querySelectorAll('.rack-item');
      rackItems.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('insertButton').disabled = false;
    }

    function insertRack() {
      if (!selectedRack) {
        alert('Please select a rack first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('insertButton');
      button.disabled = true;
      button.textContent = 'Placing rack...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place Rack in Selected Cell';
          button.disabled = false;

          // Show success feedback
          showToast('Rack placed successfully!');
        })
        .withFailureHandler(function(error) {
          alert('Error placing rack: ' + error.message);
          button.textContent = 'Place Rack in Selected Cell';
          button.disabled = false;
        })
        .insertSelectedRack(selectedRack);
    }

    function filterRacks() {
      var searchText = document.getElementById('searchBox').value.toLowerCase();

      if (!searchText) {
        renderRacks(allRacks);
        return;
      }

      var filtered = allRacks.filter(function(rack) {
        return (rack.itemNumber && rack.itemNumber.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.itemName && rack.itemName.toLowerCase().indexOf(searchText) !== -1) ||
               (rack.description && rack.description.toLowerCase().indexOf(searchText) !== -1);
      });

      renderRacks(filtered);
    }

    function showError(error) {
      document.getElementById('rackList').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <div><strong>Error loading racks</strong></div>
          <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
            ${error.message}
          </div>
        </div>
      `;
    }

    function showToast(message) {
      var toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: #188038;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 14px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.remove();
      }, 2000);
    }

    function showRacksHelp() {
      alert(
        'üóÑÔ∏è RACKS TAB HELP\n\n' +
        'WHAT IT SHOWS:\n' +
        '‚Ä¢ All rack configuration tabs in this spreadsheet\n' +
        '‚Ä¢ Automatically updates when you create new racks\n\n' +
        'HOW TO USE:\n' +
        '1. Select cell(s) in your overview layout\n' +
        '2. Choose a rack from the list\n' +
        '3. Click "Place Rack in Selected Cell"\n\n' +
        'TIPS:\n' +
        '‚Ä¢ Select single cell for 1x1 placement\n' +
        '‚Ä¢ Select multiple cells for merged placement\n' +
        '‚Ä¢ Use "From Arena" tab to create new racks'
      );
    }

    function showArenaHelp() {
      alert(
        'üåê FROM ARENA TAB HELP\n\n' +
        'WHAT IT DOES:\n' +
        '‚Ä¢ Browse ALL items from your Arena workspace\n' +
        '‚Ä¢ Auto-create rack configuration with BOM\n' +
        '‚Ä¢ Perfect for items without existing rack tabs\n\n' +
        'HOW TO USE:\n' +
        '1. Search for an Arena item\n' +
        '2. Select it from the list\n' +
        '3. Select cell(s) in overview\n' +
        '4. Click "Place Item (Auto-Create Rack)"\n\n' +
        'WHAT HAPPENS:\n' +
        '‚Ä¢ Creates new rack config tab\n' +
        '‚Ä¢ Pulls BOM from Arena\n' +
        '‚Ä¢ Places rack in overview\n' +
        '‚Ä¢ Adds to "Racks" tab list automatically'
      );
    }

    // Arena Items Tab Functions
    function loadArenaItems() {
      // Only load once
      if (arenaItemsLoaded) {
        return;
      }

      document.getElementById('arenaItemList').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading Arena items...</div>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(data) {
          allArenaItems = data.items || [];
          filteredArenaItems = allArenaItems;
          arenaItemsLoaded = true;

          // Build lookup for quantities tab
          arenaItemsLookup = {};
          allArenaItems.forEach(function(item) {
            var number = item.number || item.Number;
            if (number) {
              arenaItemsLookup[number] = item;
            }
          });

          renderArenaItems(filteredArenaItems);
        })
        .withFailureHandler(function(error) {
          document.getElementById('arenaItemList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <div><strong>Error loading Arena items</strong></div>
              <div style="margin-top: 8px; font-size: 12px; color: #d93025;">
                ${error.message}
              </div>
            </div>
          `;
        })
        .loadItemPickerData();
    }

    function renderArenaItems(items) {
      var html = '';

      if (items.length === 0) {
        html = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div><strong>No items found</strong></div>
            <div style="margin-top: 8px; font-size: 12px;">
              Try adjusting your search
            </div>
          </div>
        `;
      } else {
        items.forEach(function(item) {
          var itemNumber = item.number || item.Number || '';
          var itemName = item.name || item.Name || '';
          var description = item.description || item.Description || '';
          var categoryName = item.categoryName || '';
          var lifecyclePhase = item.lifecyclePhase || '';

          html += `
            <div class="rack-item" onclick="selectArenaItem('${itemNumber}')">
              <div class="rack-number">${itemNumber}</div>
              <div class="rack-name">${itemName}</div>
              ${description ? '<div class="rack-description">' + description + '</div>' : ''}
              <div class="rack-stats">
                ${categoryName ? '<span>üìÅ ' + categoryName + '</span>' : ''}
                ${lifecyclePhase ? '<span>üîÑ ' + lifecyclePhase + '</span>' : ''}
              </div>
            </div>
          `;
        });
      }

      document.getElementById('arenaItemList').innerHTML = html;
    }

    function selectArenaItem(itemNumber) {
      selectedArenaItem = allArenaItems.find(function(item) {
        var number = item.number || item.Number || '';
        return number === itemNumber;
      });

      // Update UI
      var items = document.querySelectorAll('#arenaItemList .rack-item');
      items.forEach(function(item) {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Enable insert button
      document.getElementById('arenaInsertButton').disabled = false;
    }

    function filterArenaItems() {
      var searchText = document.getElementById('arenaSearchBox').value.toLowerCase();

      if (!searchText) {
        filteredArenaItems = allArenaItems;
      } else {
        filteredArenaItems = allArenaItems.filter(function(item) {
          var number = (item.number || item.Number || '').toLowerCase();
          var name = (item.name || item.Name || '').toLowerCase();
          var description = (item.description || item.Description || '').toLowerCase();
          var category = (item.categoryName || '').toLowerCase();

          return number.indexOf(searchText) !== -1 ||
                 name.indexOf(searchText) !== -1 ||
                 description.indexOf(searchText) !== -1 ||
                 category.indexOf(searchText) !== -1;
        });
      }

      renderArenaItems(filteredArenaItems);
    }

    function insertArenaItem() {
      if (!selectedArenaItem) {
        alert('Please select an Arena item first');
        return;
      }

      // Disable button during insertion
      var button = document.getElementById('arenaInsertButton');
      button.disabled = true;
      button.textContent = 'Creating rack & pulling BOM...';

      google.script.run
        .withSuccessHandler(function() {
          button.textContent = 'Place Item (Auto-Create Rack)';
          button.disabled = false;

          // Reload rack list and update the UI
          google.script.run
            .withSuccessHandler(function(racks) {
              allRacks = racks;
              // Update the visual display in the Racks tab
              renderRacks(racks);
              console.log('‚úÖ Rack list refreshed - ' + racks.length + ' racks available');

              // Show success feedback with rack count
              var rackName = selectedArenaItem.number || selectedArenaItem.name;
              showToast('‚úÖ Rack "' + rackName + '" created!\nüì¶ ' + racks.length + ' rack(s) available in Racks tab');
            })
            .getAllRackConfigurationsForPicker();
        })
        .withFailureHandler(function(error) {
          alert('Error placing item: ' + error.message);
          button.textContent = 'Place Item (Auto-Create Rack)';
          button.disabled = false;
        })
        .insertSelectedRack(selectedArenaItem);
    }

    // Quantities Tab Functions
    function changeScope(scope) {
      currentScope = scope;

      // Update button states
      var buttons = document.querySelectorAll('.scope-btn');
      buttons.forEach(function(btn) {
        btn.classList.remove('active');
        if (btn.dataset.scope === scope) {
          btn.classList.add('active');
        }
      });

      // Update scope name
      var scopeNames = {
        'current': 'Current Sheet',
        'overview': 'Overview Only',
        'racks': 'All Rack Configurations',
        'all': 'All Sheets'
      };
      document.getElementById('scopeName').textContent = scopeNames[scope];

      // Reload quantities
      loadQuantities();
    }

    function loadQuantities() {
      document.getElementById('quantitiesLoading').classList.remove('hidden');
      document.getElementById('quantityListContainer').innerHTML = '';

      google.script.run
        .withSuccessHandler(function(data) {
          quantities = data.quantities || {};
          renderQuantities();
          document.getElementById('quantitiesLoading').classList.add('hidden');
        })
        .withFailureHandler(function(error) {
          console.error('Error loading quantities:', error);
          document.getElementById('quantitiesLoading').classList.add('hidden');
          document.getElementById('quantityListContainer').innerHTML =
            '<div class="empty-state"><p>Error loading rack usage</p></div>';
        })
        .getRackQuantitiesWithScope(currentScope);
    }

    function renderQuantities() {
      var container = document.getElementById('quantityListContainer');
      container.innerHTML = '';

      var rackNumbers = Object.keys(quantities);

      if (rackNumbers.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No racks found in selected scope</p></div>';
        document.getElementById('uniqueCount').textContent = '0';
        document.getElementById('totalQuantity').textContent = '0';
        return;
      }

      var totalQty = 0;

      // Sort by quantity (descending)
      rackNumbers.sort(function(a, b) {
        return quantities[b] - quantities[a];
      });

      rackNumbers.forEach(function(number) {
        var qty = quantities[number];
        totalQty += qty;

        var item = document.createElement('div');
        item.className = 'quantity-item';

        // Add color indicator - get color from server using same logic as placement
        var colorIndicator = document.createElement('div');
        colorIndicator.className = 'qty-color-indicator';
        colorIndicator.style.backgroundColor = getAutoRackColor(number);

        var info = document.createElement('div');
        var numberSpan = document.createElement('div');
        numberSpan.className = 'qty-item-number';
        numberSpan.textContent = number;

        // Try to find rack name and GUID
        var matchingRack = allRacks.find(function(r) { return r.itemNumber === number; });

        // Check arena items lookup for GUID if not in rack configs
        var itemGuid = null;
        if (matchingRack && matchingRack.guid) {
          itemGuid = matchingRack.guid;
        } else if (arenaItemsLookup[number]) {
          itemGuid = arenaItemsLookup[number].guid || arenaItemsLookup[number].Guid;
        }

        // Make rack number clickable to open in Arena
        if (itemGuid) {
          numberSpan.style.cursor = 'pointer';
          numberSpan.title = 'Open in Arena';
          numberSpan.onclick = function() {
            openItemInArena(itemGuid);
          };
        }

        if (matchingRack && matchingRack.itemName) {
          var nameSpan = document.createElement('div');
          nameSpan.className = 'qty-item-name';
          nameSpan.textContent = matchingRack.itemName;
          info.appendChild(numberSpan);
          info.appendChild(nameSpan);
        } else {
          info.appendChild(numberSpan);
        }

        var badge = document.createElement('span');
        badge.className = 'qty-badge';
        badge.textContent = qty;

        item.appendChild(colorIndicator);
        item.appendChild(info);
        item.appendChild(badge);
        container.appendChild(item);
      });

      document.getElementById('uniqueCount').textContent = rackNumbers.length;
      document.getElementById('totalQuantity').textContent = totalQty;
    }

    // Helper function to open item in Arena
    function openItemInArena(itemGuid) {
      if (!itemGuid) {
        alert('Item GUID not available');
        return;
      }

      // Get workspace ID from server and construct Arena URL
      google.script.run
        .withSuccessHandler(function(workspaceId) {
          if (workspaceId) {
            // Arena web UI URL format: https://app.arenasolutions.com/<workspaceId>/item/<itemGuid>
            var arenaUrl = 'https://app.arenasolutions.com/' + workspaceId + '/item/' + itemGuid;
            window.open(arenaUrl, '_blank');
          } else {
            alert('Workspace ID not configured');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error getting workspace ID:', error);
          alert('Could not open item in Arena: ' + error.message);
        })
        .getWorkspaceId();
    }

    // Generate auto color for rack (matches server-side logic)
    function getAutoRackColor(rackNumber) {
      if (!rackNumber) {
        return '#E3F2FD'; // Default light blue
      }

      // Simple hash function for consistent colors
      var hash = 0;
      for (var i = 0; i < rackNumber.length; i++) {
        hash = rackNumber.charCodeAt(i) + ((hash << 5) - hash);
      }

      // Convert to HSL for better color distribution
      var h = Math.abs(hash % 360);           // Hue: 0-360
      var s = 65 + (Math.abs(hash) % 20);     // Saturation: 65-85%
      var l = 80 + (Math.abs(hash >> 8) % 15); // Lightness: 80-95% (pastel)

      return hslToHex(h, s, l);
    }

    // Convert HSL to Hex
    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;

      var c = (1 - Math.abs(2 * l - 1)) * s;
      var x = c * (1 - Math.abs((h / 60) % 2 - 1));
      var m = l - c/2;
      var r = 0, g = 0, b = 0;

      if (0 <= h && h < 60) {
        r = c; g = x; b = 0;
      } else if (60 <= h && h < 120) {
        r = x; g = c; b = 0;
      } else if (120 <= h && h < 180) {
        r = 0; g = c; b = x;
      } else if (180 <= h && h < 240) {
        r = 0; g = x; b = c;
      } else if (240 <= h && h < 300) {
        r = x; g = 0; b = c;
      } else if (300 <= h && h < 360) {
        r = c; g = 0; b = x;
      }

      var rHex = Math.round((r + m) * 255).toString(16).padStart(2, '0');
      var gHex = Math.round((g + m) * 255).toString(16).padStart(2, '0');
      var bHex = Math.round((b + m) * 255).toString(16).padStart(2, '0');

      return '#' + rHex + gHex + bHex;
    }
  </script>
</body>
</html>
