<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 18px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .category-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }

    .category-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .category-item:hover {
      background-color: #e3f2fd;
    }

    .category-item.selected {
      background-color: #2196F3;
      color: white;
    }

    .category-item.parent {
      font-weight: 600;
    }

    .category-item.child {
      padding-left: 35px;
      background-color: #f9f9f9;
    }

    .category-item.hidden {
      display: none;
    }

    .expand-icon {
      width: 20px;
      margin-right: 8px;
      text-align: center;
      font-size: 12px;
      color: #666;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .category-content {
      flex: 1;
    }

    .category-name {
      font-weight: 500;
      font-size: 14px;
    }

    .category-path {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .category-item.selected .category-path {
      color: rgba(255,255,255,0.8);
    }

    .favorite-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-weight: bold;
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 8px;
      padding: 0 5px;
    }

    .buttons {
      margin-top: 20px;
      text-align: right;
    }

    button {
      padding: 8px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-cancel {
      background-color: #f0f0f0;
      color: #333;
    }

    .btn-cancel:hover {
      background-color: #e0e0e0;
    }

    .btn-ok {
      background-color: #2196F3;
      color: white;
    }

    .btn-ok:hover {
      background-color: #1976D2;
    }

    .btn-ok:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .error {
      color: #d32f2f;
      font-size: 13px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="title">Select Category</h2>
    <div class="subtitle" id="subtitle"></div>

    <div id="favoriteSection" class="favorite-section" style="display: none;">
      <div class="section-title">⭐ Favorite Categories</div>
      <div class="category-list" id="favoriteList"></div>
    </div>

    <div>
      <div class="section-title">All Categories</div>
      <div class="category-list" id="categoryList"></div>
    </div>

    <div class="error" id="error" style="display: none;"></div>

    <div class="buttons">
      <button class="btn-cancel" onclick="cancel()">Cancel</button>
      <button class="btn-ok" id="okButton" onclick="submit()" disabled>OK</button>
    </div>
  </div>

  <script>
    var selectedCategory = null;
    var categories = [];
    var favorites = [];

    // Get data from server
    google.script.run
      .withSuccessHandler(function(data) {
        categories = data.categories;
        favorites = data.favorites;

        document.getElementById('title').textContent = data.title;
        document.getElementById('subtitle').textContent = data.subtitle;

        renderCategories();
      })
      .withFailureHandler(function(error) {
        document.getElementById('error').textContent = 'Error loading categories: ' + error;
        document.getElementById('error').style.display = 'block';
      })
      .getCategorySelectorData();

    function renderCategories() {
      // Render favorites (keep flat list)
      if (favorites.length > 0) {
        document.getElementById('favoriteSection').style.display = 'block';
        var favoriteHtml = '';
        favorites.forEach(function(cat) {
          favoriteHtml += createFavoriteCategoryHtml(cat);
        });
        document.getElementById('favoriteList').innerHTML = favoriteHtml;
      }

      // Render all categories hierarchically
      var tree = buildCategoryTree(categories);
      var allHtml = renderCategoryTree(tree);
      document.getElementById('categoryList').innerHTML = allHtml;
    }

    function buildCategoryTree(cats) {
      var rootNodes = [];
      var nodeMap = {};

      // First pass: create nodes and map by full path
      cats.forEach(function(cat) {
        var node = {
          category: cat,
          children: [],
          isParent: false
        };
        nodeMap[cat.fullPath] = node;
      });

      // Second pass: build tree structure
      cats.forEach(function(cat) {
        var node = nodeMap[cat.fullPath];
        if (!cat.path || cat.path === '') {
          // Root level category
          rootNodes.push(node);
        } else {
          // Find parent by path
          var parentPath = cat.path;
          var parent = nodeMap[parentPath];
          if (parent) {
            parent.children.push(node);
            parent.isParent = true;
          } else {
            // Parent not found, add as root
            rootNodes.push(node);
          }
        }
      });

      return rootNodes;
    }

    function renderCategoryTree(nodes, level) {
      level = level || 0;
      var html = '';

      nodes.forEach(function(node) {
        var cat = node.category;
        var hasChildren = node.children.length > 0;

        if (hasChildren) {
          // Parent node with expand/collapse
          html += '<div class="category-item parent" id="parent-' + cat.guid + '" ' +
                  'onclick="toggleExpand(\'' + cat.guid + '\')">' +
                  '<span class="expand-icon" id="icon-' + cat.guid + '">▶</span>' +
                  '<div class="category-content">' +
                  '<div class="category-name">' + cat.name + '</div>' +
                  '</div>' +
                  '</div>';

          // Render children (initially hidden)
          node.children.forEach(function(child) {
            html += createChildCategoryHtml(child.category, cat.guid);
          });
        } else {
          // Leaf node (selectable)
          html += createCategoryHtml(cat, false);
        }
      });

      return html;
    }

    function createFavoriteCategoryHtml(cat) {
      var pathHtml = cat.path ? '<div class="category-path">' + cat.path + '</div>' : '';
      return '<div class="category-item" id="fav-' + cat.guid + '" ' +
             'onclick="selectCategory(\'' + cat.guid + '\', \'' + cat.name.replace(/'/g, "\\'") + '\')">' +
             '<div class="category-content">' +
             '<div class="category-name">' + cat.name + '</div>' +
             pathHtml +
             '</div></div>';
    }

    function createCategoryHtml(cat, isFavorite) {
      var prefix = isFavorite ? 'fav-' : 'cat-';
      var pathHtml = cat.path ? '<div class="category-path">' + cat.path + '</div>' : '';

      return '<div class="category-item" id="' + prefix + cat.guid + '" ' +
             'onclick="selectCategory(\'' + cat.guid + '\', \'' + cat.name.replace(/'/g, "\\'") + '\')">' +
             '<div class="category-content">' +
             '<div class="category-name">' + cat.name + '</div>' +
             pathHtml +
             '</div></div>';
    }

    function createChildCategoryHtml(cat, parentGuid) {
      var pathHtml = cat.path ? '<div class="category-path">' + cat.path + '</div>' : '';
      return '<div class="category-item child hidden" id="cat-' + cat.guid + '" data-parent="' + parentGuid + '" ' +
             'onclick="event.stopPropagation(); selectCategory(\'' + cat.guid + '\', \'' + cat.name.replace(/'/g, "\\'") + '\')">' +
             '<div class="category-content">' +
             '<div class="category-name">' + cat.name + '</div>' +
             pathHtml +
             '</div></div>';
    }

    function toggleExpand(guid) {
      var icon = document.getElementById('icon-' + guid);
      var children = document.querySelectorAll('[data-parent="' + guid + '"]');

      var isExpanded = icon.classList.contains('expanded');

      if (isExpanded) {
        // Collapse
        icon.classList.remove('expanded');
        children.forEach(function(child) {
          child.classList.add('hidden');
        });
      } else {
        // Expand
        icon.classList.add('expanded');
        children.forEach(function(child) {
          child.classList.remove('hidden');
        });
      }
    }

    function selectCategory(guid, name) {
      // Deselect all
      var items = document.querySelectorAll('.category-item');
      items.forEach(function(item) {
        item.classList.remove('selected');
      });

      // Select this one (both in favorites and all if it appears in both)
      var elem1 = document.getElementById('fav-' + guid);
      var elem2 = document.getElementById('cat-' + guid);
      var elem3 = document.getElementById('parent-' + guid);
      if (elem1) elem1.classList.add('selected');
      if (elem2) elem2.classList.add('selected');
      if (elem3) elem3.classList.add('selected');

      selectedCategory = {
        guid: guid,
        name: name
      };

      document.getElementById('okButton').disabled = false;
    }

    function submit() {
      if (!selectedCategory) {
        document.getElementById('error').textContent = 'Please select a category';
        document.getElementById('error').style.display = 'block';
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          document.getElementById('error').textContent = 'Error: ' + error;
          document.getElementById('error').style.display = 'block';
        })
        .setCategorySelection(selectedCategory);
    }

    function cancel() {
      google.script.run.setCategorySelection(null);
      google.script.host.close();
    }
  </script>
</body>
</html>
