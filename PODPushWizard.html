<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 0;
      background: #f5f7fa;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .wizard-header {
      background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
      color: white;
      padding: 24px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .wizard-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .wizard-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .stage-indicator {
      display: flex;
      justify-content: space-between;
      padding: 20px 32px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .stage-item {
      flex: 1;
      text-align: center;
      position: relative;
      padding: 0 16px;
    }

    .stage-item:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -8px;
      top: 16px;
      width: 16px;
      height: 2px;
      background: #e0e0e0;
    }

    .stage-item.active::after {
      background: #1a73e8;
    }

    .stage-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #757575;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .stage-item.active .stage-number {
      background: #1a73e8;
      color: white;
    }

    .stage-item.completed .stage-number {
      background: #34a853;
      color: white;
    }

    .stage-label {
      font-size: 13px;
      color: #757575;
      font-weight: 500;
    }

    .stage-item.active .stage-label {
      color: #1a73e8;
      font-weight: 600;
    }

    .wizard-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
    }

    .stage-panel {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .stage-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #202124;
      margin-bottom: 8px;
    }

    .section-description {
      font-size: 13px;
      color: #5f6368;
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .data-table {
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      overflow: hidden;
      margin-bottom: 16px;
    }

    .data-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }

    .data-table th {
      padding: 8px 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .form-input {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .form-input.error {
      border-color: #d93025;
    }

    .category-cell {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .category-display {
      flex: 1;
      padding: 6px 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
      color: #5f6368;
      font-style: italic;
    }

    .category-display.selected {
      background: #e8f0fe;
      color: #1a73e8;
      font-style: normal;
      font-weight: 500;
    }

    .btn-select-category {
      padding: 6px 12px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-select-category:hover {
      background: #1557b0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .bom-visualization {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      margin-top: 24px;
    }

    .bom-tree {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
      color: #202124;
    }

    .bom-tree-item {
      padding: 4px 0;
    }

    .bom-tree-pod {
      color: #1a73e8;
      font-weight: 600;
    }

    .bom-tree-row {
      color: #34a853;
      font-weight: 600;
      margin-left: 24px;
    }

    .bom-tree-rack {
      color: #ea4335;
      font-weight: 500;
      margin-left: 48px;
    }

    .wizard-footer {
      background: white;
      border-top: 1px solid #e0e0e0;
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: #f1f3f4;
      color: #5f6368;
    }

    .btn-secondary:hover {
      background: #e8eaed;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background: #1557b0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .btn-success {
      background: #34a853;
      color: white;
    }

    .btn-success:hover {
      background: #2d9249;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .info-box {
      background: #e8f0fe;
      border-left: 4px solid #1a73e8;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 24px;
    }

    .info-box-title {
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .info-box-content {
      font-size: 13px;
      color: #5f6368;
      line-height: 1.5;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #fce8e6;
      border-left: 4px solid #d93025;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 24px;
      display: none;
    }

    .error-message.active {
      display: block;
    }

    .error-message-title {
      font-weight: 600;
      color: #d93025;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .error-message-content {
      font-size: 13px;
      color: #5f6368;
      line-height: 1.5;
    }

    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      margin-bottom: 16px;
    }

    .summary-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #202124;
      margin-bottom: 12px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: #5f6368;
      font-weight: 500;
    }

    .summary-value {
      color: #202124;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="wizard-header">
    <h1>POD Structure Push Wizard</h1>
    <p>Create and push your complete POD structure to Arena in three easy steps</p>
  </div>

  <!-- Stage Indicator -->
  <div class="stage-indicator">
    <div class="stage-item active" data-stage="1">
      <div class="stage-number">1</div>
      <div class="stage-label">Racks</div>
    </div>
    <div class="stage-item" data-stage="2">
      <div class="stage-number">2</div>
      <div class="stage-label">Rows</div>
    </div>
    <div class="stage-item" data-stage="3">
      <div class="stage-number">3</div>
      <div class="stage-label">POD & Review</div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="wizard-content">
    <!-- Error Message -->
    <div class="error-message" id="errorMessage">
      <div class="error-message-title">Error</div>
      <div class="error-message-content" id="errorContent"></div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
      <div class="spinner"></div>
      <div id="loadingText">Loading...</div>
    </div>

    <!-- Stage 1: Placeholder Racks -->
    <div class="stage-panel active" id="stage1">
      <div class="section-title">Configure Placeholder Racks</div>
      <div class="section-description">
        Fill in details for each rack. Click "Select Category" to choose from favorites or search all categories.
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th style="width: 15%;">Part Number</th>
              <th style="width: 20%;">Name</th>
              <th style="width: 30%;">Description</th>
              <th style="width: 25%;">Category</th>
              <th style="width: 10%;">Items</th>
            </tr>
          </thead>
          <tbody id="racksTableBody">
            <!-- Populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Stage 2: Rows -->
    <div class="stage-panel" id="stage2">
      <div class="section-title">Configure Rows</div>
      <div class="section-description">
        Rows are auto-generated from your overview layout. Customize names and categories as needed.
      </div>

      <div class="data-table">
        <table>
          <thead>
            <tr>
              <th style="width: 15%;">Row Number</th>
              <th style="width: 25%;">Name</th>
              <th style="width: 25%;">Category</th>
              <th style="width: 25%;">Positions</th>
              <th style="width: 10%;">Racks</th>
            </tr>
          </thead>
          <tbody id="rowsTableBody">
            <!-- Populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Stage 3: POD & Review -->
    <div class="stage-panel" id="stage3">
      <div class="section-title">POD Configuration & Review</div>
      <div class="section-description">
        Configure your POD item and review the complete structure before creating it in Arena.
      </div>

      <div class="summary-card">
        <div class="summary-card-title">POD Details</div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 500; color: #5f6368; margin-bottom: 8px;">POD Name</label>
          <input type="text" id="podName" class="form-input" placeholder="e.g., Data Center Pod A">
        </div>
        <div>
          <label style="display: block; font-size: 13px; font-weight: 500; color: #5f6368; margin-bottom: 8px;">POD Category</label>
          <div class="category-cell">
            <div class="category-display" id="podCategoryDisplay">Click 'Select Category' to choose...</div>
            <button class="btn-select-category" onclick="selectPODCategory()">Select Category</button>
          </div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-card-title">üìä Structure Summary</div>
        <div class="summary-item">
          <span class="summary-label">Total Racks</span>
          <span class="summary-value" id="summaryTotalRacks">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">New Racks to Create</span>
          <span class="summary-value" id="summaryNewRacks">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Rows</span>
          <span class="summary-value" id="summaryTotalRows">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Components</span>
          <span class="summary-value" id="summaryTotalComponents">0</span>
        </div>
      </div>

      <div class="bom-visualization">
        <div class="summary-card-title" style="margin-bottom: 16px;">üå≥ BOM Structure Preview</div>
        <div class="bom-tree" id="bomTreePreview">
          <!-- Populated dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="wizard-footer">
    <button class="btn btn-secondary" id="btnBack" onclick="previousStage()" style="display: none;">
      ‚Üê Back
    </button>
    <div style="flex: 1;"></div>
    <button class="btn btn-secondary" onclick="cancelWizard()">
      Cancel
    </button>
    <button class="btn btn-primary" id="btnNext" onclick="nextStage()">
      Next ‚Üí
    </button>
    <button class="btn btn-success" id="btnCreate" onclick="createStructure()" style="display: none;">
      Create in Arena
    </button>
  </div>

  <script>
    let currentStage = 1;
    let wizardData = {
      racks: [],
      rows: [],
      pod: {
        name: '',
        category: null
      }
    };
    let selectedCategoryRow = null;

    // Initialize wizard with data from server
    function initializeWizard(data) {
      console.log('Initializing wizard with data:', data);
      wizardData = data;
      renderRacksTable();
      renderRowsTable();
      updateSummary();
    }

    // Render racks table
    function renderRacksTable() {
      const tbody = document.getElementById('racksTableBody');
      tbody.innerHTML = '';

      wizardData.racks.forEach((rack, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${rack.itemNumber}</strong></td>
          <td>
            <input type="text"
                   class="form-input"
                   value="${rack.name || ''}"
                   onchange="updateRackField(${index}, 'name', this.value)"
                   placeholder="Enter rack name">
          </td>
          <td>
            <input type="text"
                   class="form-input"
                   value="${rack.description || ''}"
                   onchange="updateRackField(${index}, 'description', this.value)"
                   placeholder="Enter description">
          </td>
          <td>
            <div class="category-cell">
              <div class="category-display ${rack.category ? 'selected' : ''}" id="rackCategory${index}">
                ${rack.category ? rack.category.name : 'Click \'Select Category\' to choose...'}
              </div>
              <button class="btn-select-category" onclick="selectRackCategory(${index})">Select Category</button>
            </div>
          </td>
          <td style="text-align: center; color: #5f6368;">${rack.childCount || 0}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render rows table
    function renderRowsTable() {
      const tbody = document.getElementById('rowsTableBody');
      tbody.innerHTML = '';

      wizardData.rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        const positionsText = row.positions.map(p => p.position).join(', ');
        tr.innerHTML = `
          <td><strong>${row.rowNumber}</strong></td>
          <td>
            <input type="text"
                   class="form-input"
                   value="${row.name || 'ROW-' + row.rowNumber}"
                   onchange="updateRowField(${index}, 'name', this.value)"
                   placeholder="Enter row name">
          </td>
          <td>
            <div class="category-cell">
              <div class="category-display ${row.category ? 'selected' : ''}" id="rowCategory${index}">
                ${row.category ? row.category.name : 'Click \'Select Category\' to choose...'}
              </div>
              <button class="btn-select-category" onclick="selectRowCategory(${index})">Select Category</button>
            </div>
          </td>
          <td style="color: #5f6368; font-size: 13px;">${positionsText}</td>
          <td style="text-align: center; color: #5f6368;">${row.positions.length}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Update rack field
    function updateRackField(index, field, value) {
      wizardData.racks[index][field] = value;
    }

    // Update row field
    function updateRowField(index, field, value) {
      wizardData.rows[index][field] = value;
    }

    // Select category for rack
    function selectRackCategory(index) {
      selectedCategoryRow = { type: 'rack', index: index };
      google.script.run
        .withSuccessHandler(onCategorySelected)
        .withFailureHandler(onError)
        .showCategorySelector();
    }

    // Select category for row
    function selectRowCategory(index) {
      selectedCategoryRow = { type: 'row', index: index };
      google.script.run
        .withSuccessHandler(onCategorySelected)
        .withFailureHandler(onError)
        .showCategorySelector();
    }

    // Select category for POD
    function selectPODCategory() {
      selectedCategoryRow = { type: 'pod', index: null };
      google.script.run
        .withSuccessHandler(onCategorySelected)
        .withFailureHandler(onError)
        .showCategorySelector();
    }

    // Category selected callback
    function onCategorySelected(category) {
      console.log('Category selected:', category);

      if (!selectedCategoryRow) return;

      if (selectedCategoryRow.type === 'rack') {
        const idx = selectedCategoryRow.index;
        wizardData.racks[idx].category = category;
        document.getElementById('rackCategory' + idx).textContent = category.name;
        document.getElementById('rackCategory' + idx).classList.add('selected');
      } else if (selectedCategoryRow.type === 'row') {
        const idx = selectedCategoryRow.index;
        wizardData.rows[idx].category = category;
        document.getElementById('rowCategory' + idx).textContent = category.name;
        document.getElementById('rowCategory' + idx).classList.add('selected');
      } else if (selectedCategoryRow.type === 'pod') {
        wizardData.pod.category = category;
        document.getElementById('podCategoryDisplay').textContent = category.name;
        document.getElementById('podCategoryDisplay').classList.add('selected');
      }

      selectedCategoryRow = null;
    }

    // Navigation
    function nextStage() {
      if (!validateCurrentStage()) return;

      currentStage++;
      updateStageUI();

      if (currentStage === 3) {
        updateSummary();
        renderBOMPreview();
      }
    }

    function previousStage() {
      currentStage--;
      updateStageUI();
    }

    function updateStageUI() {
      // Update stage indicators
      document.querySelectorAll('.stage-item').forEach(item => {
        const stage = parseInt(item.dataset.stage);
        item.classList.remove('active', 'completed');
        if (stage === currentStage) {
          item.classList.add('active');
        } else if (stage < currentStage) {
          item.classList.add('completed');
        }
      });

      // Update panels
      document.querySelectorAll('.stage-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById('stage' + currentStage).classList.add('active');

      // Update buttons
      document.getElementById('btnBack').style.display = currentStage > 1 ? 'inline-block' : 'none';
      document.getElementById('btnNext').style.display = currentStage < 3 ? 'inline-block' : 'none';
      document.getElementById('btnCreate').style.display = currentStage === 3 ? 'inline-block' : 'none';
    }

    // Validation
    function validateCurrentStage() {
      const errorMsg = document.getElementById('errorMessage');
      const errorContent = document.getElementById('errorContent');

      errorMsg.classList.remove('active');

      if (currentStage === 1) {
        // Validate racks
        for (let i = 0; i < wizardData.racks.length; i++) {
          const rack = wizardData.racks[i];
          if (!rack.name) {
            errorContent.textContent = `Rack ${rack.itemNumber}: Name is required`;
            errorMsg.classList.add('active');
            return false;
          }
          if (!rack.description) {
            errorContent.textContent = `Rack ${rack.itemNumber}: Description is required`;
            errorMsg.classList.add('active');
            return false;
          }
          if (!rack.category) {
            errorContent.textContent = `Rack ${rack.itemNumber}: Category is required`;
            errorMsg.classList.add('active');
            return false;
          }
        }
      } else if (currentStage === 2) {
        // Validate rows
        for (let i = 0; i < wizardData.rows.length; i++) {
          const row = wizardData.rows[i];
          if (!row.name) {
            errorContent.textContent = `Row ${row.rowNumber}: Name is required`;
            errorMsg.classList.add('active');
            return false;
          }
          if (!row.category) {
            errorContent.textContent = `Row ${row.rowNumber}: Category is required`;
            errorMsg.classList.add('active');
            return false;
          }
        }
      }

      return true;
    }

    // Update summary
    function updateSummary() {
      const podName = document.getElementById('podName').value;
      wizardData.pod.name = podName;

      document.getElementById('summaryTotalRacks').textContent = wizardData.racks.length + wizardData.existingRacks.length;
      document.getElementById('summaryNewRacks').textContent = wizardData.racks.length;
      document.getElementById('summaryTotalRows').textContent = wizardData.rows.length;

      // Calculate total components
      let totalComponents = 0;
      wizardData.racks.forEach(r => totalComponents += (r.childCount || 0));
      wizardData.existingRacks.forEach(r => totalComponents += (r.childCount || 0));
      document.getElementById('summaryTotalComponents').textContent = totalComponents;
    }

    // Render BOM preview
    function renderBOMPreview() {
      const preview = document.getElementById('bomTreePreview');
      let html = '';

      html += `<div class="bom-tree-item bom-tree-pod">üì¶ ${wizardData.pod.name || 'POD'}</div>`;

      wizardData.rows.forEach(row => {
        html += `<div class="bom-tree-item bom-tree-row">‚îú‚îÄ üìä ${row.name} (${row.positions.length} positions)</div>`;

        row.positions.forEach((pos, idx) => {
          const isLast = idx === row.positions.length - 1;
          const prefix = isLast ? '‚îî‚îÄ' : '‚îú‚îÄ';
          html += `<div class="bom-tree-item bom-tree-rack">   ${prefix} üîß ${pos.itemNumber} @ Pos ${pos.position}</div>`;
        });
      });

      preview.innerHTML = html;
    }

    // Create structure
    function createStructure() {
      // Update POD data
      wizardData.pod.name = document.getElementById('podName').value;

      if (!wizardData.pod.name) {
        showError('POD name is required');
        return;
      }

      if (!wizardData.pod.category) {
        showError('POD category is required');
        return;
      }

      // Show loading
      document.getElementById('loadingIndicator').classList.add('active');
      document.getElementById('loadingText').textContent = 'Creating structure in Arena...';
      document.querySelector('.wizard-content').style.display = 'none';

      // Send to server
      google.script.run
        .withSuccessHandler(onCreateSuccess)
        .withFailureHandler(onCreateError)
        .executePODPush(wizardData);
    }

    // Success handler
    function onCreateSuccess(result) {
      alert('Success!\n\nPOD structure created in Arena:\n‚Ä¢ Created ' + result.racksCreated + ' rack(s)\n‚Ä¢ Created ' + result.rowsCreated + ' row(s)\n‚Ä¢ Created POD: ' + result.podItemNumber);
      google.script.host.close();
    }

    // Error handlers
    function onCreateError(error) {
      document.getElementById('loadingIndicator').classList.remove('active');
      document.querySelector('.wizard-content').style.display = 'block';
      showError('Failed to create structure: ' + error.message);
    }

    function onError(error) {
      showError(error.message || 'An error occurred');
    }

    function showError(message) {
      const errorMsg = document.getElementById('errorMessage');
      const errorContent = document.getElementById('errorContent');
      errorContent.textContent = message;
      errorMsg.classList.add('active');

      // Scroll to top
      document.querySelector('.wizard-content').scrollTop = 0;
    }

    // Cancel wizard
    function cancelWizard() {
      if (confirm('Are you sure you want to cancel? All entered data will be lost.')) {
        google.script.host.close();
      }
    }

    // Update POD name
    document.addEventListener('DOMContentLoaded', function() {
      const podNameInput = document.getElementById('podName');
      if (podNameInput) {
        podNameInput.addEventListener('input', function() {
          updateSummary();
        });
      }
    });
  </script>
</body>
</html>
